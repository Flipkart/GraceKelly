<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Gracekelly by Flipkart</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/Flipkart/GraceKelly">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/Flipkart/GraceKelly/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/Flipkart/GraceKelly/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Gracekelly</h1>
          <p>A Best Effort Cache Synchronization Library In Java</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/Flipkart">Flipkart</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <h1>
<a name="gracekelly" class="anchor" href="#gracekelly"><span class="octicon octicon-link"></span></a>GraceKelly</h1>

<h4>
<a name="a-best-effort-cache-synchronization-library-for-distributed-systems" class="anchor" href="#a-best-effort-cache-synchronization-library-for-distributed-systems"><span class="octicon octicon-link"></span></a>a best effort cache synchronization library for distributed systems</h4>

<p>GraceKelly is a best effort cache synchronization library designed to
shield distributed systems and services from direct exposure to
unpredictable request loads. It improves load and response SLA
predictability in distributed environments. It also enables graceful
degradation with stale data as fallback, in a degraded distributed
ecosystem.</p>

<h2>
<a name="why-is-it-needed" class="anchor" href="#why-is-it-needed"><span class="octicon octicon-link"></span></a>Why is it needed?</h2>

<h4>
<a name="a-chaotic-place" class="anchor" href="#a-chaotic-place"><span class="octicon octicon-link"></span></a>A chaotic place</h4>

<p>Any big distributed environment is inherently
complex and chaotic. This complexity arises due to the complex
dependencies between different services. The variability of the
requests and responses that this environment is exposed to makes it a
chaotic place</p>

<p><img src="https://img3a.flixcart.com//www/promos/new/20130905-115236-soa.png"></p>

<p>This chaos means the predictability of load and latency is
reduced. This makes the environment and it’s SLAs vulnerable to
arbitrary request loads. It’s necessary to shield the environment from
such externally induced unpredictability. Since service SLAs are
affected by service load, such shielding also ensures their
predictability. This means, one must systemically strive to hold on to
as much predictability as possible when building a service/system.</p>

<h4>
<a name="sheilds-up" class="anchor" href="#sheilds-up"><span class="octicon octicon-link"></span></a>Sheilds up</h4>

<p>Caches act as sentinels in an distributed environment. Although their
primary function is to reduce latency, when used appropriately they
excel at bringing predictability to a system. That’s because a cache
request is extremely predictable, with almost no variability, either
in response times or the load per request. One could say that there is
positive co-relation between the percentage of Cache hits and the
predictability of a system/environment.</p>

<p><img src="https://img1a.flixcart.com//www/promos/new/20130905-115342-soa-cached.png"></p>

<h4>
<a name="cache-expiry" class="anchor" href="#cache-expiry"><span class="octicon octicon-link"></span></a>Cache expiry</h4>

<p>Every time there is a cache miss the environment and SLAs become a
little bit more vulnerable. In this context, the common cache usage
pattern of expiry based on a ttl and subsequent re-population seems
risky. Using cache expiry as a proxy/trigger for cache synchronization
exposes the underlying system to potentially harmful request pattern
load for the duration of synchronization.</p>

<ul>
<li>
<strong>t0</strong> – a heavily requested cache entry c1 expires</li>
<li>
<strong>t1</strong> – there is a cache miss for c1 and a request is sent to the service to fulfill</li>
<li>
<strong>t2</strong> – the cache has been repopulated with c2</li>
</ul><p>The time between <strong>t1</strong> and <strong>t2</strong> is the duration of exposure. The
predictability of the target service and all the services it depends
on during this time is affected by the the per request load and the
qps of all requests that result in a cache miss for c1.</p>

<p><img src="https://img1a.flixcart.com//www/promos/new/20130906-135948-cache-expiry.jpg"></p>

<p>What would be good to have is a cache library with regular caching
semantics but one that accommodates refreshing a cache entry rather
than expiring it based on ttl. This is exactly what GraceKelly is,
it’s inspired by Gooogle Guava’s LoadingCache.</p>

<h2>
<a name="what-does-it-do" class="anchor" href="#what-does-it-do"><span class="octicon octicon-link"></span></a>What does it do?</h2>

<p>GraceKelly tries it’s best to refresh the cache entry that has
expired. The refresh lifecycle is purely request triggered and doesn’t
monitor/maintain the cache. For every request</p>

<ul>
<li>It looks up the cache and returns the value if a cache entry is present.</li>
<li>If the returned cache entry has expired it dispatches a task to refresh the cache entry.</li>
<li>If for some reason the refresh fails, it can extend the ttl of the existing entry or do nothing.</li>
</ul><p>Note that a cache entry is never removed(though it can be evicted by
size constraints).</p>

<p>This does two things.</p>

<ul>
<li>Shields the backend services and systems from exposure to unnecessary request load.<br>
</li>
<li>Decouples response SLAs from backend degradation and availability concerns, there by allowing for graceful degradation with stale data as fallback.</li>
</ul><p><img src="https://img1a.flixcart.com//www/promos/new/20130906-135939-cache-refresh.jpg"></p>

<h2>
<a name="the-library" class="anchor" href="#the-library"><span class="octicon octicon-link"></span></a>The Library</h2>

<p>The library has a single Class <strong>Kelly</strong> that takes implementations of
two different interfaces a <strong>CacheProvider</strong> and a
<strong>CacheLoader</strong>. They pass around a <strong>CacheEntry</strong></p>

<h4>
<a name="kelly" class="anchor" href="#kelly"><span class="octicon octicon-link"></span></a>Kelly</h4>

<p>Kelly is the primary class for Gracekelly that reloads cacheEntries when they expire.
It has a very simple interface for usage.</p>

<div class="highlight highlight-java"><pre>    <span class="cm">/**</span>
<span class="cm">    * obtain an instance of a CacheProvider implementation</span>
<span class="cm">    * here the RemoteCache can be a wrapper to some kind of</span>
<span class="cm">    * memcached client.</span>
<span class="cm">    */</span>
    <span class="n">CacheProvider</span><span class="o">&lt;</span><span class="n">CachedObject</span><span class="o">&gt;</span> <span class="n">cacheProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">RemoteCache</span><span class="o">();</span>

    <span class="cm">/**</span>
<span class="cm">    * obtain an instance of a CacheLoader implementation</span>
<span class="cm">    */</span>
    <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">CachedObject</span><span class="o">&gt;</span> <span class="n">cacheLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MyCacheLoader</span><span class="o">();</span>

    <span class="cm">/**</span>
<span class="cm">    * Fix the threadpool size for the number of threads that will</span>
<span class="cm">    * be used to reload cache entries</span>
<span class="cm">    */</span>
    <span class="n">Integer</span> <span class="n">threadPoolSize</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">    * Create a kelly reloading cache instance with the provided</span>
<span class="cm">    * cacheProvider, cacheLoader and threadPoolSize</span>
<span class="cm">    */</span>
    <span class="n">Kelly</span><span class="o">&lt;</span><span class="n">CachedObject</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Kelly</span><span class="o">(</span><span class="n">cacheProvider</span><span class="o">,</span> <span class="n">cacheLoader</span><span class="o">,</span> <span class="n">threadPoolSize</span><span class="o">);</span>

    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"sample_key"</span><span class="o">;</span>
    <span class="n">CachedObject</span> <span class="n">value</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">CachedObject</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">expiryTtl</span> <span class="o">=</span> <span class="mi">300</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">    * Create a CacheEntry instance with the given</span>
<span class="cm">    * key, value and ttl for expiry</span>
<span class="cm">    */</span>
    <span class="n">CacheEntry</span> <span class="n">cacheEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">CacheEntry</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">expiryTtl</span><span class="o">);</span>

    <span class="c1">//put a CacheEntry in Cache</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">cacheEntry</span><span class="o">);</span>

    <span class="c1">//get value from cache</span>
    <span class="n">CachedObject</span> <span class="n">cachedValue</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>

    <span class="c1">//expire a cache key</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">expire</span><span class="o">(</span><span class="n">key</span><span class="o">);</span> <span class="c1">//doesn't remove from cache</span>
</pre></div>

<p>One has to note that expired entries are not replaced as soon as they have expired but
an attempt is made to refresh them using the CacheLoader the first time an expired
CacheEntry is encountered during a get request.</p>

<h4>
<a name="cacheprovider" class="anchor" href="#cacheprovider"><span class="octicon octicon-link"></span></a>CacheProvider</h4>

<p>The CacheProvider interface is used to implement adapters to different cache implementations where the cached values
are finally persisted and retrieved from. For eg: one would implement a CacheProvider for couchbase or memcached.</p>

<div class="highlight highlight-java"><pre>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CacheProvider</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;{</span>
    <span class="cm">/**</span>
<span class="cm">     * Returns a {@link CacheEntry}&lt;T&gt; if it is present in the underlying cache,</span>
<span class="cm">     * or it returns a null otherwise.</span>
<span class="cm">     * @param key</span>
<span class="cm">     * @return {@link CacheEntry}&lt;T&gt; for the given key or return null if not present</span>
<span class="cm">     * @throws CacheProviderException</span>
<span class="cm">     */</span>
    <span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CacheProviderException</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Tries to update the cache with the given {@link CacheEntry}&lt;T&gt; for the given key</span>
<span class="cm">     * @param key</span>
<span class="cm">     * @param value</span>
<span class="cm">     * @return true or false based on the success of putting the {@link CacheEntry}&lt;T&gt;</span>
<span class="cm">     * into the cache.</span>
<span class="cm">     * @throws CacheProviderException</span>
<span class="cm">     */</span>
    <span class="n">Boolean</span> <span class="nf">put</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CacheProviderException</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>

<p>A trivial CacheProvider implementation for a local cache with a ConcurrentHashMap
could look like the following.</p>

<div class="highlight highlight-java"><pre>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">LocalCacheProvider</span> <span class="kd">implements</span> <span class="n">CacheProvider</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;();</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CacheProviderException</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"key"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">put</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CacheProviderException</span> <span class="o">{</span>
            <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">value</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>

<h4>
<a name="cacheloader" class="anchor" href="#cacheloader"><span class="octicon octicon-link"></span></a>CacheLoader</h4>

<p>The CacheLoader provides a single method to reload cache, based on an existing entry in the cache.
The implementation of CacheLoader should be able to reload the cache given the key of the and the
previous value of the CacheEntry.</p>

<div class="highlight highlight-java"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CacheLoader</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Takes a {@link String} key and a value/Object of type &lt;T&gt; and returns a</span>
<span class="cm">     * {@link CacheEntry}&lt;T&gt;. The implementation of this method is supposed to</span>
<span class="cm">     * return the CacheEntry with the latest Value for the given key.</span>
<span class="cm">     * @param key</span>
<span class="cm">     * @param prevValue</span>
<span class="cm">     * @return {@link CacheEntry} of the type parameter specified during</span>
<span class="cm">     * declaration of this instance of CacheLoader</span>
<span class="cm">     * @throws CacheLoaderException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">reload</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">T</span> <span class="n">prevValue</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CacheLoaderException</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>

<h4>
<a name="cacheentry" class="anchor" href="#cacheentry"><span class="octicon octicon-link"></span></a>CacheEntry</h4>

<p>The CacheEntry class is a simple java object that holds data required to get, put and invalidate a
cache entry. The generic parameter indicates the type of the object that will be stored against the
given key. usage is as follows, where the <strong>ttl is in seconds</strong></p>

<div class="highlight highlight-java"><pre><span class="c1">//cache entry valid for 5 minutes since time of creation</span>
<span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">CachedObject</span><span class="o">&gt;</span> <span class="n">cacheEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">CachedObject</span><span class="o">&gt;(</span><span class="s">"key"</span><span class="o">,</span> <span class="n">someObject</span><span class="o">,</span> <span class="mi">300</span><span class="o">);</span>

<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="c1">//returns the key of the CacheEntry</span>
<span class="n">CachedObject</span> <span class="o">=</span> <span class="n">cahceEntry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="c1">//returns value of the CacheEntry</span>
<span class="kt">long</span> <span class="n">ttl</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">.</span><span class="na">getTtl</span><span class="o">()</span> <span class="c1">//returns the ttl in seconds</span>
</pre></div>

<h2>
<a name="maven-artifact" class="anchor" href="#maven-artifact"><span class="octicon octicon-link"></span></a>Maven Artifact</h2>

<p>Add the following repository to your pom.xml</p>

<div class="highlight highlight-xml"><pre>    <span class="nt">&lt;repository&gt;</span>
      <span class="nt">&lt;id&gt;</span>clojars<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;name&gt;</span>Clojars repository<span class="nt">&lt;/name&gt;</span>
      <span class="nt">&lt;url&gt;</span>https://clojars.org/repo<span class="nt">&lt;/url&gt;</span>
    <span class="nt">&lt;/repository&gt;</span>
</pre></div>

<p>And add the following dependency to start using GraceKelly in your maven project.</p>

<div class="highlight highlight-xml"><pre>   <span class="nt">&lt;dependency&gt;</span>
     <span class="nt">&lt;groupId&gt;</span>com.flipkart.lego<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>gracekelly-core<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;version&gt;</span>1.3.3<span class="nt">&lt;/version&gt;</span>
   <span class="nt">&lt;/dependency&gt;</span>
</pre></div>

<h2>
<a name="documentation" class="anchor" href="#documentation"><span class="octicon octicon-link"></span></a>Documentation</h2>

<p>The api docs can be found <a href="http://flipkart.github.io/GraceKelly/docs/index.html">here</a></p>

<h2>
<a name="contribution-bugs-and-feedback" class="anchor" href="#contribution-bugs-and-feedback"><span class="octicon octicon-link"></span></a>Contribution, Bugs and Feedback</h2>

<p>For bugs, questions and discussions please use the <a href="https://github.com/Flipkart/GraceKelly/issues">Github Issues</a>.
Please follow the <a href="https://github.com/Flipkart/GraceKelly/blob/master/CONTRIBUTING.md">contribution guidelines</a> when submitting pull requests.</p>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>Copyright 2013 Flipkart Internet, pvt ltd.</p>

<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-43777098-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>